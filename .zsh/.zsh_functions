#!/bin/zsh

# this function returns location and other information from an ip address
whoip () {
	if ! hash curl 2>/dev/null; then
		echo "Please install curl to continue.\ne.g. >sudo apt-get install curl -y";
		return 1;
	fi

	echo checking ip address: $1
	curl http://ipinfo.io/$1
}

# this function reports the IP addresses that accessed blog posts and which posts were accessed

whoread () {
	
	if [ ! -f ~/.zsh_env ]; then
		echo "Please supply a ~/.zsh_env file with a MY_IP var to continue.";
		return 1;
	fi

	if ! hash jq 2>/dev/null; then
		echo "Please install jq to continue.\ne.g. >sudo apt-get install jq -y";
		return 1;
	fi

	# loads env variables
	. ~/.zsh_env

	# gets all records in nginx logs that retrieve blog posts
	zgrep '/posts/' /var/log/nginx/simple-access* \
		| grep -v "$MY_IP" \
		| awk -F '|' '{print $2}' \
		| sort | uniq \
		> /tmp/ip_query.txt

	echo "All IPs that retrieved blog posts from the website:"
	cat /tmp/ip_query.txt

	# queries for location info for each ip
	</tmp/ip_query.txt xargs -I % curl -s http://ipinfo.io/% \
		| jq -r '.ip + ":\t" + .city + ", " + .region + " " + .country' \
		> /tmp/ip_locs.txt

	echo "\nThe location of each ip:"
	cat /tmp/ip_locs.txt

	# all requests to retrieve blog posts
	zgrep -h '/posts/' /var/log/nginx/simple-access* \
		| grep -v "$MY_IP" \
		| grep -v 'favicon.ico' \
		| awk -F '|' '{print $1,$2,$5}' \
		> /tmp/ip_posts.txt

	echo "\nThe blog posts and times accessed:"
	cat /tmp/ip_posts.txt
}

moddirs () {
	MOD=755;

	if [ ! -d "$1" ]; then
		echo "Please enter a root directory to begin directory chmod.";
		return 1;
	fi

	if [ "$2" ]; then 
		MOD="$2"
	fi


	find "$1" -type d -exec sudo chmod "$MOD" {} \;
	echo "directories under $1 set to $MOD";
}

modfiles () {
	MOD=644;

	if [ ! -d "$1" ]; then
		echo "Please enter a root directory to begin file chmod.";
		return 1;
	fi

	if [ "$2" ]; then 
		MOD="$2"
	fi

	find "$1" -type f -exec sudo chmod "$MOD" {} \;
	echo "directories under $1 set to $MOD";
}
